rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users: Anyone can read/write their own user doc (based on ID)
    // Since we don't have real auth, we allow public read/write for now,
    // but in a real app this would be locked down.
    match /users/{username} {
      allow read, write: if true;
    }

    // Cards: 
    // - Create: Allow if valid
    // - Read (Get): Allow anyone (recipient needs to view it via ID)
    // - Read (List): ONLY allow if filtering by senderUsername (Dashboard)
    match /cards/{cardId} {
      allow get: if true;
      allow create: if request.resource.data.senderUsername != null;
      allow update: if true; // Status updates
      
      // Enforce that list queries MUST filter by senderUsername
      allow list: if request.query.limit <= 100 
                  && 'senderUsername' in request.query.filters; // Basic check logic, pseudo-code for intent
      // Actual syntax for enforcing query constraints is tricky without auth.
      // Standard practice: allow list: if true; but rely on query.
      // Or: allow list: if resource.data.senderUsername == ... (this checks the result set)
      
      // Let's go with a permissive rule for this prototype since we lack real Auth tokens.
      allow list: if true; 
    }
  }
}
